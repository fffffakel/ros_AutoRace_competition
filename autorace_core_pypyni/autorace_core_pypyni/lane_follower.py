import rclpy
from rclpy.node import Node
from rclpy.qos import QoSProfile, ReliabilityPolicy, HistoryPolicy
from sensor_msgs.msg import Image, LaserScan
from geometry_msgs.msg import Twist
from std_msgs.msg import String
from cv_bridge import CvBridge
import cv2
import numpy as np
import math

# –£–∑–µ–ª lane_follower.py
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º —Ä–æ–±–æ—Ç–∞ –ø–æ –ø–æ–ª–æ—Å–µ (–∂–µ–ª—Ç–∞—è/–±–µ–ª–∞—è –ª–∏–Ω–∏–∏) –∏ —Ä–µ–∂–∏–º 'construction' (–ø—Ä–æ–µ–∑–¥ –∫–æ—Ä–∏–¥–æ—Ä–∞ –∏–∑ –∫–æ–Ω—É—Å–æ–≤).
#
# –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:
#   1) –ö–∞–º–µ—Ä–∞ -> –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤—ã—Ö –º–∞—Å–æ–∫ –ª–∏–Ω–∏–π (–∂–µ–ª—Ç–∞—è —Å–ª–µ–≤–∞, –±–µ–ª–∞—è —Å–ø—Ä–∞–≤–∞).
#   2) –ü–æ –º–∞—Å–∫–∞–º –∏—â–µ–º —Ü–µ–Ω—Ç—Ä—ã –ª–∏–Ω–∏–π (moments) –∏ –≤—ã—á–∏—Å–ª—è–µ–º —Ü–µ–ª–µ–≤—É—é —Ç–æ—á–∫—É target_center (–∫—É–¥–∞ –¥–æ–ª–∂–µ–Ω '—Å–º–æ—Ç—Ä–µ—Ç—å' —Ä–æ–±–æ—Ç –ø–æ X).
#   3) –û—à–∏–±–∫–∞ error = (—Ü–µ–Ω—Ç—Ä –∫–∞–¥—Ä–∞) - target_center.
#   4) PID (–ø–æ error) —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —É–≥–ª–æ–≤—É—é —Å–∫–æ—Ä–æ—Å—Ç—å w (angular.z), –∞ –ª–∏–Ω–µ–π–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø—Ä–∏ –±–æ–ª—å—à–æ–º |w|.
#
# –†–µ–∂–∏–º—ã –¥–≤–∏–∂–µ–Ω–∏—è –∑–∞–¥–∞—é—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –≤ —Ç–æ–ø–∏–∫–µ /course_code:
#   left/right/center  - –≤—ã–±–æ—Ä —Ü–µ–ª–µ–≤–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª–æ—Å—ã;
#   construction       - –∫–æ—Ä–∏–¥–æ—Ä –∏–∑ –∫–æ–Ω—É—Å–æ–≤: –∫–æ–Ω—É—Å—ã –≤–Ω–∏–∑—É –∫–∞–¥—Ä–∞ '—Ä–∞—Å—à–∏—Ä—è—é—Ç' –º–∞—Å–∫–∏ –ª–∏–Ω–∏–π, —á—Ç–æ–±—ã –µ—Ö–∞—Ç—å –º–µ–∂–¥—É –Ω–∏–º–∏;
#   go/stop            - —Ä–∞–∑—Ä–µ—à–∏—Ç—å/–∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é –¥–≤–∏–∂–µ–Ω–∏—è.
#
# –õ–∏–¥–∞—Ä (/scan) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ construction –∫–∞–∫ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞:
#   - —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è, –µ—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ —Å—Ç–µ–Ω–∞/–∫–æ–Ω—É—Å—ã;
#   - –∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω–æ–≥–æ '—Ñ–∏–Ω–∏—à–∞' –ø—Ä–∏ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ—Ç–µ—Ä–µ –º–∞—Å–∫–∏ –∫–æ–Ω—É—Å–æ–≤.


# –ö–ª–∞—Å—Å ROS2-–Ω–æ–¥—ã. –°–æ–¥–µ—Ä–∂–∏—Ç:
#   - –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–º–µ—Ä—É, –∫–æ–º–∞–Ω–¥—ã –º–∏—Å—Å–∏–π –∏ –ª–∏–¥–∞—Ä;
#   - –ø—É–±–ª–∏–∫–∞—Ü–∏—é /cmd_vel;
#   - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞.
# –í–∞–∂–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø: –Ω–æ–¥–∞ —Å–∞–º–∞ –ù–ï –≤—ã–±–∏—Ä–∞–µ—Ç –º–∏—Å—Å–∏–∏, –æ–Ω–∞ –ª–∏—à—å –∏—Å–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç perception/mission_control —á–µ—Ä–µ–∑ /course_code.


class LaneFollower(Node):
    def __init__(self):
        super().__init__("lane_follower")

        # QoS-–ø—Ä–æ—Ñ–∏–ª–∏:
        #   camera –∏ lidar: BEST_EFFORT + depth=1, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –∫–∞–¥—Ä/—Å–∫–∞–Ω –∏ –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É.
        #   –∫–æ–º–∞–Ω–¥—ã: RELIABLE + depth=10, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã 'left/right/...' –Ω–µ —Ç–µ—Ä—è–ª–∏—Å—å.

        qos_camera = QoSProfile(
            reliability=ReliabilityPolicy.BEST_EFFORT,
            history=HistoryPolicy.KEEP_LAST,
            depth=1,
        )
        qos_command = QoSProfile(
            reliability=ReliabilityPolicy.RELIABLE,
            history=HistoryPolicy.KEEP_LAST,
            depth=10,
        )
        qos_lidar = QoSProfile(
            reliability=ReliabilityPolicy.BEST_EFFORT,
            history=HistoryPolicy.KEEP_LAST,
            depth=1,
        )

        # –ü–æ–¥–ø–∏—Å–∫–∏:
        #   /color/image  -> –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–Ω—Å–æ—Ä –¥–ª—è –ø–æ–ª–æ—Å/–∫–æ–Ω—É—Å–æ–≤.
        #   /course_code  -> –≤–Ω–µ—à–Ω–∏–π '—Ä–µ–∂–∏–º–Ω—ã–π' —Å–∏–≥–Ω–∞–ª (—á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å).
        #   /scan         -> —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é —Å–ø–µ—Ä–µ–¥–∏ (—Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –ª–æ–≥–∏–∫–∏ –∑–∞–≤—è–∑–∞–Ω–∞ –Ω–∞ –ª–∏–¥–∞—Ä).

        self.sub_camera = self.create_subscription(
            Image, "/color/image", self.camera_callback, qos_camera
        )
        self.sub_command = self.create_subscription(
            String, "/course_code", self.command_callback, qos_command
        )
        self.sub_scan = self.create_subscription(
            LaserScan, "/scan", self.scan_callback, qos_lidar
        )

        # –ü–∞–±–ª–∏—à–µ—Ä—ã:
        #   /cmd_vel        -> —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π (Twist).
        #   /robot_finish   -> —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∏ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –º–∏—Å—Å–∏–∏ (–∏–º—è –∫–æ–º–∞–Ω–¥—ã).
        #   /course_code    -> –æ–±—Ä–∞—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 'stop'), —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ñ–∏–Ω–∏—à–∞.

        self.pub_cmd_vel = self.create_publisher(Twist, "/cmd_vel", 10)

        self.pub_finish = self.create_publisher(String, "/robot_finish", 10)
        self.pub_course_code = self.create_publisher(String, "/course_code", 10)

        # –°–ª—É–∂–µ–±–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è:
        #   bridge     - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ROS Image <-> OpenCV.
        #   twist      - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –æ–±—ä–µ–∫—Ç –∫–æ–º–∞–Ω–¥—ã —Å–∫–æ—Ä–æ—Å—Ç–∏.
        #   stop_robot - '–ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å': –µ—Å–ª–∏ True, –ø—É–±–ª–∏–∫—É–µ–º –Ω—É–ª–∏ –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PID.

        self.bridge = CvBridge()
        self.twist = Twist()
        self.stop_robot = True

        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –∏ —Ä–µ–∂–∏–º–∞:
        #   scan_ranges     - –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–∞—Å—Å–∏–≤ –¥–∞–ª—å–Ω–æ—Å—Ç–µ–π –ª–∏–¥–∞—Ä–∞ (inf –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ 10.0).
        #   lane_width_px   - –æ—Ü–µ–Ω–∫–∞ —à–∏—Ä–∏–Ω—ã –ø–æ–ª–æ—Å—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö (cw - cy), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ª–∏–Ω–∏—è.
        #   mode            - —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º (left/right/center/construction).
        #
        # –§–∏–Ω–∏—à –≤ construction:
        #   - no_cone_timer     —Å—á–∏—Ç–∞–µ—Ç –∫–∞–¥—Ä—ã '–Ω–µ—Ç –∫–æ–Ω—É—Å–æ–≤' (–ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∫–æ–Ω—É—Å—ã –±—ã–ª–∏ –∑–∞–º–µ—á–µ–Ω—ã).
        #   - seen_cones        –∑–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω–æ–≥–æ —Ñ–∏–Ω–∏—à–∞ —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Ä–µ–∂–∏–º.
        #   - cones_seen_streak —Ç—Ä–µ–±—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤ —Å –∫–æ–Ω—É—Å–∞–º–∏, —á—Ç–æ–±—ã –ø—Ä–∏–∑–Ω–∞—Ç—å '–∫–æ–Ω—É—Å—ã –±—ã–ª–∏'.
        #   - NO_CONE_THRESHOLD –∏ CONE_SEEN_THRESHOLD –∑–∞–¥–∞—é—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —à—É–º—É.
        #   - is_finished       –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Ñ–∏–Ω–∏—à–∞.

        self.scan_ranges = []
        self.lane_width_px = 300
        self.mode = "center"

        self.no_cone_timer = 0

        self.seen_cones = False
        self.cones_seen_streak = 0
        self.NO_CONE_THRESHOLD = 160
        self.CONE_SEEN_THRESHOLD = 8
        self.is_finished = False
        self.team_name = "–ø—É–ø—É–Ω–∏"

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã PID:
        #   error (–≤ –ø–∏–∫—Å–µ–ª—è—Ö) -> w (—É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å).
        #   Kp - —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Ç–µ–∫—É—â—É—é –æ—à–∏–±–∫—É (–æ—Å–Ω–æ–≤–Ω–æ–π –≤–∫–ª–∞–¥).
        #   Ki - –∏–Ω—Ç–µ–≥—Ä–∞–ª (–∑–¥–µ—Å—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω, —á—Ç–æ–±—ã –Ω–µ '–Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å' –≤ –ø–æ–≤–æ—Ä–æ—Ç–∞—Ö).
        #   Kd - –¥–µ–º–ø—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—à–∏–±–∫–∏).
        #
        # –°–∫–æ—Ä–æ—Å—Ç—å:
        #   desiredV - –±–∞–∑–æ–≤–∞—è –ª–∏–Ω–µ–π–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–∂–∏–º–∞.
        #   –î–∞–ª–µ–µ –æ–Ω–∞ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –ø–æ–≤–æ—Ä–æ—Ç–∞—Ö (|w|), —á—Ç–æ–±—ã —Ä–æ–±–æ—Ç –Ω–µ –≤—ã–ª–µ—Ç–∞–ª —Å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏.

        self.Kp = 0.005
        self.Ki = 0.0000
        self.Kd = 0.005

        self.desiredV = 0.15
        self.E = [0] * 15
        self.old_e = 0

        self.get_logger().info("Lane Follower: FULL SYSTEM READY")

    # scan_callback(msg: LaserScan)
    # –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –º–∞—Å—Å–∏–≤ –¥–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –µ–≥–æ:
    #   - –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å (inf) –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ '–¥–∞–ª–µ–∫–æ' (10.0), —á—Ç–æ–±—ã min() —Ä–∞–±–æ—Ç–∞–ª –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
    # –í–∞–∂–Ω–æ: –¥–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ –∫–∞—á–µ—Å—Ç–≤—É; –¥–∞–ª–µ–µ –∫–æ–¥ —Å–∞–º –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π —Å–µ–∫—Ç–æ—Ä.

    def scan_callback(self, msg):
        self.scan_ranges = [r if not math.isinf(r) else 10.0 for r in msg.ranges]

    # command_callback(msg: String)
    # –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–Ω–µ—à–Ω—é—é –∫–æ–º–∞–Ω–¥—É —Ä–µ–∂–∏–º–∞ –∏–∑ /course_code.
    # –õ–æ–≥–∏–∫–∞:
    #   - left/right/center/construction: –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å mode, —Å–Ω—è—Ç—å stop_robot, —Å–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã.
    #   - stop: –≤–∫–ª—é—á–∏—Ç—å stop_robot (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pid_control).
    #   - go: —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ (stop_robot=False).

    def command_callback(self, msg):
        cmd = msg.data.lower().strip()
        if cmd in ["left", "right", "center", "construction"]:
            self.mode = cmd
            self.stop_robot = False
            self.no_cone_timer = 0
            if cmd == "construction":
                self.seen_cones = False
                self.cones_seen_streak = 0
            else:
                self.cones_seen_streak = 0
            if cmd == "construction":

                self.seen_cones = False
            self.get_logger().info(f"üëâ MODE: {cmd.upper()}")
        elif cmd == "stop":
            self.stop_robot = True
            self.get_logger().info("üõë ROBOT STOPPED (Command)")
        elif cmd == "go":
            self.stop_robot = False

    # camera_callback(msg: Image)
    # –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ –∫–∞–º–µ—Ä—ã):
    #   1) –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ROS->OpenCV.
    #   2) –í—ã–±–æ—Ä ROI (–Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å –∫–∞–¥—Ä–∞), –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ª–∏–Ω–∏–∏/–∫–æ–Ω—É—Å—ã.
    #   3) HSV -> —Ü–≤–µ—Ç–æ–≤—ã–µ –º–∞—Å–∫–∏ –ª–∏–Ω–∏–π –∏ –∫–æ–Ω—É—Å–æ–≤.
    #   4) –ï—Å–ª–∏ construction: –∫–æ–Ω—É—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ '–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã' (—Ä–∞—Å—à–∏—Ä—è–µ–º –º–∞—Å–∫–∏), –ø–ª—é—Å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º —Ñ–∏–Ω–∏—à.
    #   5) –ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—Ç—Ä—ã –ª–∏–Ω–∏–π (moments), –≤—ã—á–∏—Å–ª—è–µ–º target_center.
    #   6) error -> PID -> –ø—É–±–ª–∏–∫–∞—Ü–∏—è /cmd_vel.

    def camera_callback(self, msg):
        try:
            cv_image = self.bridge.imgmsg_to_cv2(msg, "bgr8")
        except:
            return

        # ROI (–æ–±–ª–∞—Å—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–∞): –±–µ—Ä—ë–º –Ω–∏–∂–Ω–∏–µ ~30% –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
        # –ü—Ä–∏—á–∏–Ω–∞: —Ä–∞–∑–º–µ—Ç–∫–∞/–∫–æ–Ω—É—Å—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ –¥–æ—Ä–æ–≥–µ –≤–Ω–∏–∑—É; –≤–µ—Ä—Ö –∫–∞–¥—Ä–∞ —á–∞—â–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–æ–Ω/—à—É–º –∏ —É—Ö—É–¥—à–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.

        height, width, _ = cv_image.shape
        crop_img = cv_image[int(height * 0.7) : height, 0:width]
        hsv = cv2.cvtColor(crop_img, cv2.COLOR_BGR2HSV)

        # –ú–∞—Å–∫–∏ –ª–∏–Ω–∏–π –≤ HSV:
        #   yellow - –ª–µ–≤–∞—è –ª–∏–Ω–∏—è;
        #   white  - –ø—Ä–∞–≤–∞—è –ª–∏–Ω–∏—è.
        # –î–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ–¥–æ–±—Ä–∞–Ω—ã –ø–æ–¥ —Ç–∏–ø–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞/–∫–∞–º–µ—Ä—ã –∏ –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –ø–æ–¥ –¥—Ä—É–≥–æ–π —Å–≤–µ—Ç.

        lower_yellow = np.array([20, 80, 80])
        upper_yellow = np.array([40, 255, 255])
        lower_white = np.array([0, 0, 180])
        upper_white = np.array([180, 50, 255])
        mask_yellow = cv2.inRange(hsv, lower_yellow, upper_yellow)
        mask_white = cv2.inRange(hsv, lower_white, upper_white)

        # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—è –∑—Ä–µ–Ω–∏—è –ø–æ–ø–æ–ª–∞–º:
        #   - –∂—ë–ª—Ç—É—é –ª–∏–Ω–∏—é –∏—â–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–µ–≤–∞,
        #   - –±–µ–ª—É—é –ª–∏–Ω–∏—é –∏—â–µ–º —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞–≤–∞.
        # –≠—Ç–æ –ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∑–∫–æ —Å–Ω–∏–∂–∞–µ—Ç —á–∏—Å–ª–æ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–µ–ª—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ª–µ–≤–∞).

        h_crop, w_crop = mask_yellow.shape
        mid = int(w_crop / 2)
        mask_yellow[:, mid:] = 0
        mask_white[:, :mid] = 0

        # –ú–∞—Å–∫–∞ –∫–æ–Ω—É—Å–æ–≤ (–∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç) –≤ HSV:
        # –ö—Ä–∞—Å–Ω—ã–π –≤ HSV '—Ä–∞–∑—Ä—ã–≤–∞–µ—Ç—Å—è' —á–µ—Ä–µ–∑ 0/180, –ø–æ—ç—Ç–æ–º—É –±–µ—Ä—ë–º –¥–≤–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (0..10) –∏ (170..180) –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º.

        mask_cone1 = cv2.inRange(hsv, np.array([0, 100, 50]), np.array([10, 255, 255]))
        mask_cone2 = cv2.inRange(
            hsv, np.array([170, 100, 50]), np.array([180, 255, 255])
        )
        mask_cones = mask_cone1 | mask_cone2

        # –í–µ—Ç–≤–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–∂–∏–º—É.
        # construction –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —Ç–µ–º, —á—Ç–æ:
        #   - —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∏–∂–µ (desiredV=0.1);
        #   - –∫–æ–Ω—É—Å—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è/–≥—Ä–∞–Ω–∏—Ü—ã –∫–æ—Ä–∏–¥–æ—Ä–∞;
        #   - –≤–∫–ª—é—á–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ñ–∏–Ω–∏—à–∞ –∏ –ª–∏–¥–∞—Ä–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞.

        if self.mode == "construction":
            self.desiredV = 0.1

            # –§–∏–Ω–∏—à –≤ construction –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ–º –∫–æ–Ω—É—Å–æ–≤ –∏–∑ –∫–∞–¥—Ä–∞.
            # –ß—Ç–æ–±—ã –Ω–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫—Ä–∞—Å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤—ã—à–µ –¥–æ—Ä–æ–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–Ω–∞–∫),
            # —Å—á–∏—Ç–∞–µ–º –ø–∏–∫—Å–µ–ª–∏ –∫–æ–Ω—É—Å–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –º–∞—Å–∫–∏ (–Ω–∏–∑ –∫–∞–¥—Ä–∞).

            h_mask, w_mask = mask_cones.shape
            low_y0 = int(h_mask * 0.6)
            mask_cones_low = mask_cones[low_y0:, :]

            cone_pixels = cv2.countNonZero(mask_cones_low)

            # –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø–æ –ª–∏–¥–∞—Ä—É: min_front = –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ —É–∑–∫–æ–º —Å–µ–∫—Ç–æ—Ä–µ —Å–ø–µ—Ä–µ–¥–∏.
            # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
            #   - –≤ –ª–æ–≥–∏–∫–µ —Ñ–∏–Ω–∏—à–∞: '–Ω–µ—Ç –∫–æ–Ω—É—Å–æ–≤' –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ —É–∂–µ —Å–≤–æ–±–æ–¥–Ω–æ (min_front > 0.80),
            #     —á—Ç–æ–±—ã —Ä–æ–±–æ—Ç –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ —Å—Ç–µ–Ω–æ–π –∏–∑ –∫–æ–Ω—É—Å–æ–≤ –∏–∑-–∑–∞ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ—Ç–µ—Ä–∏ –º–∞—Å–∫–∏.
            # –°–µ–∫—Ç–æ—Ä —Å–ø–µ—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω –∫–∞–∫ 350..360 –∏ 0..10 –≥—Ä–∞–¥—É—Å–æ–≤ (–æ–∫–Ω–æ –≤–æ–∫—Ä—É–≥ –Ω—É–ª–µ–≤–æ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–∞—Ä–∞).

            min_front = 5.00
            # –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –≤ construction:
            # –ï—Å–ª–∏ –≤–ø–µ—Ä–µ–¥–∏ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ (min_f < 0.35),
            # —Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–º–µ—â–∞–µ–º target_center –≤ —Å—Ç–æ—Ä–æ–Ω—É (–≤–ø—Ä–∞–≤–æ/–≤–ª–µ–≤–æ),
            # –ø—ã—Ç–∞—è—Å—å –∏–∑–±–µ–∂–∞—Ç—å —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è.

            if len(self.scan_ranges) > 0:
                n = len(self.scan_ranges)
                sec_front = (
                    self.scan_ranges[int(n * (350 / 360)) :]
                    + self.scan_ranges[0 : int(n * (10 / 360))]
                )
                f_vals = [r for r in sec_front if r < 9.0]
                min_front = min(f_vals) if len(f_vals) > 0 else 10.0

            # cone_pixels - —á–∏—Å–ª–æ '–∫—Ä–∞—Å–Ω—ã—Ö' –ø–∏–∫—Å–µ–ª–µ–π (–∫–æ–Ω—Éc–æ–≤) –≤ –Ω–∏–∂–Ω–µ–º ROI.
            # –ü–æ—Ä–æ–≥ 150 –æ—Ç–¥–µ–ª—è–µ—Ç '–∫–æ–Ω—Éc—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–Ω—ã' –æ—Ç —à—É–º–∞/–∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.
            # cones_seen_streak —Ç—Ä–µ–±—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤ –ø–æ–¥—Ä—è–¥, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å seen_cones=True.

            if cone_pixels >= 150:
                self.cones_seen_streak += 1
            else:
                self.cones_seen_streak = 0

            if self.cones_seen_streak >= self.CONE_SEEN_THRESHOLD:
                self.seen_cones = True

            # no_cone_timer - —Å—á—ë—Ç—á–∏–∫ –∫–∞–¥—Ä–æ–≤, –∫–æ–≥–¥–∞ –∫–æ–Ω—É—Å—ã '–ø—Ä–æ–ø–∞–ª–∏'.
            # –õ–æ–≥–∏–∫–∞:
            #   - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ seen_cones=True (—Ç–æ –µ—Å—Ç—å –∫–æ–Ω—É—Å—ã —Ä–µ–∞–ª—å–Ω–æ –≤—Å—Ç—Ä–µ—á–∞–ª–∏—Å—å);
            #   - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ cone_pixels < 150 –ò –≤–ø–µ—Ä–µ–¥–∏ —Å–≤–æ–±–æ–¥–Ω–æ –ø–æ –ª–∏–¥–∞—Ä—É (min_front > 0.80);
            #   - –∏–Ω–∞—á–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ 0.
            # –≠—Ç–æ –¥–∞—ë—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫:
            #   - –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—é –∫–æ–Ω—É—Å–æ–≤ –ª–∏–Ω–∏–µ–π/–±–ª–∏–∫–æ–º,
            #   - –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø—Ä–æ–≤–∞–ª–∞–º —Ü–≤–µ—Ç–æ–≤–æ–π –º–∞—Å–∫–∏,
            #   - –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–µ–Ω–æ–π.

            if self.seen_cones:
                if cone_pixels < 150 and min_front > 0.80:
                    self.no_cone_timer += 1
                else:
                    self.no_cone_timer = 0
            else:
                self.no_cone_timer = 0

            # –¢—Ä–∏–≥–≥–µ—Ä —Ñ–∏–Ω–∏—à–∞:
            #   - –∫–æ–Ω—É—Å—ã —É–∂–µ –≤—Å—Ç—Ä–µ—á–∞–ª–∏—Å—å (seen_cones=True);
            #   - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–ª–≥–æ –Ω–µ—Ç –∫–æ–Ω—É—Å–æ–≤ (no_cone_timer > NO_CONE_THRESHOLD);
            #   - —Ñ–∏–Ω–∏—à –µ—â—ë –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª (not is_finished).
            # –î–µ–π—Å—Ç–≤–∏–µ:
            #   - –ø—É–±–ª–∏–∫—É–µ–º –∏–º—è –∫–æ–º–∞–Ω–¥—ã –≤ /robot_finish;
            #   - –ø—É–±–ª–∏–∫—É–µ–º 'stop' –≤ /course_code;
            #   - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º stop_robot=True –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω—É–ª–µ–≤–æ–π Twist.

            if (
                self.seen_cones
                and self.no_cone_timer > self.NO_CONE_THRESHOLD
                and not self.is_finished
            ):
                self.is_finished = True

                self.pub_finish.publish(String(data=self.team_name))
                self.pub_course_code.publish(String(data="stop"))
                self.stop_robot = True
                self.pub_cmd_vel.publish(Twist())

                self.get_logger().info(f"üèÅ MISSION COMPLETE! Team: {self.team_name}")
                return

            # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–Ω—É—Å–æ–≤ –≤ '–≥—Ä–∞–Ω–∏—Ü—ã –¥–æ—Ä–æ–≥–∏':
            #   - –Ω–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç—É—Ä—ã –∫–æ–Ω—É—Å–æ–≤ –≤ –Ω–∏–∂–Ω–µ–º ROI;
            #   - –±–µ—Ä—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∞–º—ã—Ö –Ω–∏–∂–Ω–∏—Ö (–±–ª–∏–∂–∞–π—à–∏—Ö) –∫–æ–Ω—Ç—É—Ä–æ–≤;
            #   - –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—É—Å–∞ —Ä–∏—Å—É–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫-–ø–æ–¥–∫–ª–∞–¥–∫—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º–∞—Å–∫—É –ª–∏–Ω–∏–∏:
            #       —Å–ª–µ–≤–∞ -> mask_yellow, —Å–ø—Ä–∞–≤–∞ -> mask_white.
            # –≠—Ñ—Ñ–µ–∫—Ç: PID –≤–∏–¥–∏—Ç '–ª–∏–Ω–∏—é' –¥–∞–∂–µ —Ç–∞–º, –≥–¥–µ –≤–º–µ—Å—Ç–æ —Ä–∞–∑–º–µ—Ç–∫–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω—É—Å—ã.

            contours, _ = cv2.findContours(
                mask_cones_low, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE
            )
            contours = sorted(
                contours, key=lambda c: cv2.boundingRect(c)[1], reverse=True
            )

            for i, cnt in enumerate(contours):
                area = cv2.contourArea(cnt)
                if area > 200:
                    x, y, w_rect, h_rect = cv2.boundingRect(cnt)
                    y = y + low_y0
                    cx_cone = x + w_rect // 2
                    pad = 25
                    if cx_cone < width / 2:
                        cv2.rectangle(
                            mask_yellow,
                            (x - pad, y - pad),
                            (x + w_rect + pad, y + h_rect + pad),
                            255,
                            -1,
                        )
                        cv2.rectangle(
                            crop_img, (x, y), (x + w_rect, y + h_rect), (0, 255, 255), 2
                        )
                    else:
                        cv2.rectangle(
                            mask_white,
                            (x - pad, y - pad),
                            (x + w_rect + pad, y + h_rect + pad),
                            255,
                            -1,
                        )
                        cv2.rectangle(
                            crop_img,
                            (x, y),
                            (x + w_rect, y + h_rect),
                            (255, 255, 255),
                            2,
                        )
                    if i >= 2:
                        break
        else:
            self.desiredV = 0.15
            self.no_cone_timer = 0

        # –ü–æ–∏—Å–∫ –ø–æ–ª–æ–∂–µ–Ω–∏—è –ª–∏–Ω–∏–π:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–º–µ–Ω—Ç—ã –±–∏–Ω–∞—Ä–Ω—ã—Ö –º–∞—Å–æ–∫.
        # cy/cw - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X —Ü–µ–Ω—Ç—Ä–∞ –º–∞—Å—Å—ã (m10/m00) –¥–ª—è –∂—ë–ª—Ç–æ–π/–±–µ–ª–æ–π –ª–∏–Ω–∏–∏.
        # –ï—Å–ª–∏ m00==0, –ª–∏–Ω–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ (None).

        M_y = cv2.moments(mask_yellow)
        cy = int(M_y["m10"] / M_y["m00"]) if M_y["m00"] > 0 else None
        M_w = cv2.moments(mask_white)
        cw = int(M_w["m10"] / M_w["m00"]) if M_w["m00"] > 0 else None

        # –û—Ü–µ–Ω–∫–∞ —à–∏—Ä–∏–Ω—ã –ø–æ–ª–æ—Å—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö.
        # –ï—Å–ª–∏ –≤–∏–¥–Ω—ã –æ–±–µ –ª–∏–Ω–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ–º lane_width_px = cw - cy.
        # –î–∞–ª–µ–µ —ç—Ç–∞ –≤–µ–ª–∏—á–∏–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ '–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –¥–æ–≥–∞–¥–∫–∞', –∫–æ–≥–¥–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ª–∏–Ω–∏—è.

        if cy and cw:
            self.lane_width_px = cw - cy

        # target_center - –∂–µ–ª–∞–µ–º–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X, –≤ –∫–æ—Ç–æ—Ä—É—é –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω —Ä–æ–±–æ—Ç.
        # –ü–æ —Å—É—Ç–∏ —ç—Ç–æ '—Ç–æ—á–∫–∞ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è' –Ω–∞ –ª–∏–Ω–∏–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ ROI.
        # safety_offset - –Ω–µ–±–æ–ª—å—à–æ–π —Å–¥–≤–∏–≥, –∫–æ—Ç–æ—Ä—ã–π –¥–µ—Ä–∂–∏—Ç —Ä–æ–±–æ—Ç–∞ –¥–∞–ª—å—à–µ –æ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞—Ö left/right.

        target_center = width / 2
        safety_offset = 40

        # –í—ã–±–æ—Ä —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ —Ä–µ–∂–∏–º—É:
        #   right: —Å–º–µ—â–∞–µ–º—Å—è –ø—Ä–∞–≤–µ–µ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–ª–æ—Å—ã;
        #   left:  —Å–º–µ—â–∞–µ–º—Å—è –ª–µ–≤–µ–µ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–ª–æ—Å—ã;
        #   center: –¥–µ—Ä–∂–∏–º —Å–µ—Ä–µ–¥–∏–Ω—É;
        #   construction: –¥–µ—Ä–∂–∏–º —Å–µ—Ä–µ–¥–∏–Ω—É –∫–æ—Ä–∏–¥–æ—Ä–∞, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –ø—Ä–æ–µ–∑–¥ –º–µ–∂–¥—É –∫–æ–Ω—É—Å–∞–º–∏.
        #
        # –ï—Å–ª–∏ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ª–∏–Ω–∏—è, target_center –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ lane_width_px –∫–∞–∫ –ø–æ–ª–æ–≤–∏–Ω–∞ —à–∏—Ä–∏–Ω—ã –ø–æ–ª–æ—Å—ã.

        if self.mode == "right":
            if cw:
                target_center = cw - (self.lane_width_px / 2) + safety_offset
            elif cy:
                target_center = cy + (self.lane_width_px / 2) + safety_offset
            else:
                target_center = width

        elif self.mode == "left":
            # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:
            #   - —Ç–æ—á–∫–∏ cy/cw –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ü–µ–Ω—Ç—Ä—ã –ª–∏–Ω–∏–π;
            #   - —Ç–æ—á–∫–∞ target_center –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ü–µ–ª—å.
            # –û–∫–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–±–∞–≥–∞; –Ω–∞ –∞–ª–≥–æ—Ä–∏—Ç–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ –≤–ª–∏—è–µ—Ç.

            if cy:
                target_center = cy + (self.lane_width_px / 2) - safety_offset
            elif cw:
                target_center = cw - (self.lane_width_px / 2) - safety_offset
            else:
                target_center = 0

        elif self.mode == "construction":
            if cy and cw:
                target_center = (cy + cw) / 2
            elif cy:
                target_center = cy + (self.lane_width_px / 2)
            elif cw:
                target_center = cw - (self.lane_width_px / 2)

            if len(self.scan_ranges) > 0:
                n = len(self.scan_ranges)
                sec_front = (
                    self.scan_ranges[int(n * (350 / 360)) :]
                    + self.scan_ranges[0 : int(n * (10 / 360))]
                )
                f_vals = [r for r in sec_front if r < 9.0]
                min_f = min(f_vals) if len(f_vals) > 0 else 10.0

                if min_f < 0.35:
                    self.get_logger().info(f"üß± WALL ({min_f:.2f})")
                    if cy and not cw:
                        target_center = width
                    elif cw and not cy:
                        target_center = 0
                    else:
                        target_center = width

        else:
            if cy and cw:
                target_center = (cy + cw) / 2
            elif cy:
                target_center = cy + (self.lane_width_px / 2)
            elif cw:
                target_center = cw - (self.lane_width_px / 2)

        # –û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
        #   error > 0  -> target_center –ø—Ä–∞–≤–µ–µ —Ü–µ–Ω—Ç—Ä–∞ –∫–∞–¥—Ä–∞, –Ω—É–∂–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ø—Ä–∞–≤–æ/—Å–º–µ—Å—Ç–∏—Ç—å—Å—è.
        #   error < 0  -> target_center –ª–µ–≤–µ–µ —Ü–µ–Ω—Ç—Ä–∞, –Ω—É–∂–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—å –≤–ª–µ–≤–æ.
        # –ó–Ω–∞–∫ –¥–∞–ª–µ–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è PID-—Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–º –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ angular.z.

        error = (width / 2) - target_center

        if cy:
            cv2.circle(crop_img, (cy, 20), 8, (0, 255, 255), -1)
        if cw:
            cv2.circle(crop_img, (cw, 20), 8, (255, 255, 255), -1)
        cv2.circle(crop_img, (int(target_center), 40), 6, (0, 255, 0), -1)

        if self.mode == "construction":
            color = (0, 255, 0) if self.no_cone_timer < 180 else (0, 0, 255)
            cv2.putText(
                crop_img,
                f"Finish Timer: {self.no_cone_timer}/{self.NO_CONE_THRESHOLD}",
                (10, 50),
                cv2.FONT_HERSHEY_SIMPLEX,
                0.6,
                color,
                2,
            )

        # –î–ï–ë–ê–ì
        # –ü–æ–∫–∞–∑ –∫–∞–¥—Ä–∞ –∏ –∫–æ—Ä–æ—Ç–∫–∏–π waitKey(1) –Ω—É–∂–Ω—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–∫–Ω–∞ OpenCV.

        # cv2.imshow("Lane Tracking", crop_img)
        # cv2.waitKey(1)

        self.pid_control(error)

    # pid_control(error)
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø–∏–∫—Å–µ–ª—å–Ω—É—é –æ—à–∏–±–∫—É –≤ –∫–æ–º–∞–Ω–¥—É —Å–∫–æ—Ä–æ—Å—Ç–∏:
    #   1) –ï—Å–ª–∏ stop_robot=True -> –ø—É–±–ª–∏–∫—É–µ–º –Ω—É–ª–∏ –∏ –≤—ã—Ö–æ–¥–∏–º.
    #   2) P: —Ç–µ–∫—É—â–∞—è –æ—à–∏–±–∫–∞.
    #   3) I: —Å—É–º–º–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—à–∏–±–æ–∫ (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ self.E).
    #   4) D: —Ä–∞–∑–Ω–∏—Ü–∞ error - old_e.
    #   5) –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º w –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [-2.0, 2.0] (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∑–∫–∏—Ö —Ä—ã–≤–∫–æ–≤).
    #   6) –õ–∏–Ω–µ–π–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å —É–º–µ–Ω—å—à–∞–µ–º –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ, –æ—Å—Ç–∞–≤–ª—è—è –Ω–∏–∂–Ω–∏–π –ø—Ä–µ–¥–µ–ª 0.05.

    def pid_control(self, error):
        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞:
        # –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –Ω–æ–¥–∞ –≤—Å–µ–≥–¥–∞ –ø—É–±–ª–∏–∫—É–µ—Ç Twist(0,0) –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤—Ö–æ–¥–Ω–æ–≥–æ error.
        # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ –∫–æ–º–∞–Ω–¥–µ 'stop' –∏–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–Ω–∏—à–∞.

        if self.stop_robot:
            self.twist.linear.x = 0.0
            self.twist.angular.z = 0.0
            self.pub_cmd_vel.publish(self.twist)
            return

        e_P = error
        self.E.pop(0)
        self.E.append(error)
        # –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ PID:
        #   w = Kp*P + Ki*I + Kd*D
        # –≥–¥–µ w ‚Äî —É–≥–ª–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (angular.z).

        w = self.Kp * e_P + self.Ki * sum(self.E) + self.Kd * (error - self.old_e)
        w = max(min(w, 2.0), -2.0)

        # –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ª–∏–Ω–µ–π–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏:
        # –ß–µ–º —Å–∏–ª—å–Ω–µ–µ –ø–æ–≤–æ—Ä–æ—Ç (–±–æ–ª—å—à–µ |w|), —Ç–µ–º –Ω–∏–∂–µ linear_v.
        # –≠—Ç–æ –ø—Ä–æ—Å—Ç–∞—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è, —á—Ç–æ–±—ã –Ω–∞ –∫—Ä—É—Ç—ã—Ö –º–∞–Ω—ë–≤—Ä–∞—Ö –Ω–µ —Å–Ω–æ—Å–∏–ª–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã.

        linear_v = self.desiredV * (1 - 0.5 * abs(w) / 2.0)
        if linear_v < 0.05:
            linear_v = 0.05

        self.twist.linear.x = linear_v
        self.twist.angular.z = float(w)
        self.pub_cmd_vel.publish(self.twist)
        self.old_e = error


# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ROS2.
# –°–æ–∑–¥–∞—ë–º –Ω–æ–¥—É, –∑–∞–ø—É—Å–∫–∞–µ–º spin() –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã (node + OpenCV –æ–∫–Ω–∞) –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.


def main(args=None):
    rclpy.init(args=args)
    node = LaneFollower()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()
        cv2.destroyAllWindows()


if __name__ == "__main__":
    main()
